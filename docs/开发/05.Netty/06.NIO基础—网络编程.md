---
title: NIOåŸºç¡€â€”ç½‘ç»œç¼–ç¨‹
date: 2023-10-18 11:05:57
permalink: /pages/affaf7/
categories:
  - å¼€å‘
  - Netty
tags:
  - 
---

## 4. ç½‘ç»œç¼–ç¨‹

### 4.1 éé˜»å¡ vs é˜»å¡

#### é˜»å¡

* é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
  * `ServerSocketChannel.accept` ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ
  * `SocketChannel.read` ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ
  * é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½® 
* å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ
* ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
  * 32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½
  * å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥

æœåŠ¡å™¨ç«¯

```java
// ä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹
// 0. ByteBuffer
ByteBuffer buffer = ByteBuffer.allocate(16);
// 1. åˆ›å»ºäº†æœåŠ¡å™¨
ServerSocketChannel ssc = ServerSocketChannel.open();

// 2. ç»‘å®šç›‘å¬ç«¯å£
ssc.bind(new InetSocketAddress(8080));

// 3. è¿æ¥é›†åˆ
List<SocketChannel> channels = new ArrayList<>();
while (true) {
    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡
    log.debug("connecting...");
    SocketChannel sc = ssc.accept(); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ
    log.debug("connected... {}", sc);
    channels.add(sc);
    for (SocketChannel channel : channels) {
        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
        log.debug("before read... {}", channel);
        channel.read(buffer); // é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ
        buffer.flip();
        debugRead(buffer);
        buffer.clear();
        log.debug("after read...{}", channel);
    }
}
```

å®¢æˆ·ç«¯

```java
SocketChannel sc = SocketChannel.open();
sc.connect(new InetSocketAddress("localhost", 8080));
System.out.println("waiting...");
```

è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“å®¢æˆ·ç«¯å‘é€äº†ä¸€æ¬¡æ•°æ®åï¼ŒæœåŠ¡å™¨å¤„ç†é€šé“ä¸­çš„æ•°æ®åï¼Œå†æ¬¡è¿›å…¥å¾ªç¯ï¼Œä¼šå†æ¬¡è¢« accept é˜»å¡ã€‚æ­¤æ—¶ä¹‹å‰çš„å®¢æˆ·ç«¯å†æ¬¡å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯ä¼šå› ä¸ºè¢«é˜»å¡è€Œæ— æ³•å¤„ç†å®¢æˆ·ç«¯å‘é€åˆ°é€šé“ä¸­çš„æ¶ˆæ¯ã€‚

#### éé˜»å¡

* éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ
  * åœ¨ `ServerSocketChannel.accept` åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ
  * `SocketChannel.read` åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ `ServerSocketChannel.accept` 
  * å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»
* ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu
* æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰

è®¾ç½®ï¼š

* å¯ä»¥é€šè¿‡ ServerSocketChannel çš„` configureBlocking(false)` æ–¹æ³•å°†è·å¾—è¿æ¥è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚æ­¤æ—¶è‹¥æ²¡æœ‰è¿æ¥ï¼Œaccept ä¼šè¿”å› null
* å¯ä»¥é€šè¿‡ SocketChannel çš„ `configureBlocking(false)` æ–¹æ³•å°†ä»é€šé“ä¸­è¯»å–æ•°æ®è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚è‹¥æ­¤æ—¶é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œread ä¼šè¿”å› -1

æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜

```java{6,13,16,21}
// ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹
// 0. ByteBuffer
ByteBuffer buffer = ByteBuffer.allocate(16);
// 1. åˆ›å»ºäº†æœåŠ¡å™¨
ServerSocketChannel ssc = ServerSocketChannel.open();
ssc.configureBlocking(false); // éé˜»å¡æ¨¡å¼
// 2. ç»‘å®šç›‘å¬ç«¯å£
ssc.bind(new InetSocketAddress(8080));
// 3. è¿æ¥é›†åˆ
List<SocketChannel> channels = new ArrayList<>();
while (true) {
    // 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡
    SocketChannel sc = ssc.accept(); // éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null
    if (sc != null) {
        log.debug("connected... {}", sc);
        sc.configureBlocking(false); // éé˜»å¡æ¨¡å¼ => èƒ½è®©ä¸‹é¢çš„ read å˜ä¸ºéé˜»å¡
        channels.add(sc);
    }
    for (SocketChannel channel : channels) {
        // 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
        int read = channel.read(buffer);// éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0
        if (read > 0) {
            buffer.flip();
            debugRead(buffer);
            buffer.clear();
            log.debug("after read...{}", channel);
        }
    }
}
```

ä»¥ä¸Šæ¨¡å¼ä¸ºåŒæ­¥éé˜»å¡ï¼Œå¹¶é NIO æ¨¡å¼ã€‚

#### å¤šè·¯å¤ç”¨

å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨

* <font color='red'>å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IOï¼Œæ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨</font>
* å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯
  * æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥
  * æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–
  * æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
    * é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶

Selectorï¼šéé˜»å¡ + äº‹ä»¶ï¼Œå½“æ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿˜æ˜¯é˜»å¡çš„ï¼Œä¸ä¼šè®©çº¿ç¨‹ç©ºè¿è¡Œ

### 4.2 Selector åŠå…¶ä½¿ç”¨

```mermaid
graph TD
subgraph selector ç‰ˆ
thread --> selector
selector --> c1(channel)
selector --> c2(channel)
selector --> c3(channel)
end
```

å¥½å¤„

* ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ
* è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨
* èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡
* å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

::: tip äº‹ä»¶ç±»å‹

- acceptï¼šæœåŠ¡ç«¯ï¼Œåœ¨æœ‰è¿æ¥è¯·æ±‚æ—¶è§¦å‘
- connnectï¼š å®¢æˆ·ç«¯ï¼Œè¿æ¥è¢«æœåŠ¡ç«¯å»ºç«‹åè§¦å‘
- readï¼šå¯è¯»äº‹ä»¶
- writeï¼šå¯å†™äº‹ä»¶

:::

> è¦åœ¨éå†é›†åˆæ—¶è¿˜è¦åˆ é™¤ï¼Œè¦ç”¨è¿­ä»£å™¨åšã€‚ä¸è¦ç”¨å¢å¼º for åšã€‚

#### åˆ›å»º

```java
Selector selector = Selector.open();
```

#### ç»‘å®š Channel äº‹ä»¶

ä¹Ÿç§°ä¹‹ä¸º**æ³¨å†Œäº‹ä»¶**ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ 

```java
channel.configureBlocking(false);
SelectionKey key = channel.register(selector, ç»‘å®šäº‹ä»¶);
```

* channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼
* FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨
* ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰
  * connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘
  * accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘
  * read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ
  * write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ

#### ç›‘å¬ Channel äº‹ä»¶

å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶

æ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ

```java
int count = selector.select();
```

æ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰

```java
int count = selector.select(long timeout);
```

æ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶

```java
int count = selector.selectNow();
```

#### ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡

> * äº‹ä»¶å‘ç”Ÿæ—¶
>   * å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶
>   * å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯<font color='red'>æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶</font>ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘<font color='red'>å¤šæ¬¡è¯»å–äº‹ä»¶</font>
>   * channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶
>   * åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶
> * è°ƒç”¨ selector.wakeup()
> * è°ƒç”¨ selector.close()
> * selector æ‰€åœ¨çº¿ç¨‹ interrupt

#### ä¸€äº›æ³¨æ„äº‹é¡¹

- æœ‰æœªå¤„ç†äº‹ä»¶æ—¶ï¼Œselect æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œæ‰€ä»¥äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç† è¦ä¹ˆå–æ¶ˆï¼ˆ`key.cancel()`ï¼‰ï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†ã€‚
- NIO ä¸­ï¼Œæ‹¿åˆ°ä¸€ä¸ª Key æ—¶ï¼Œä¸€å®šè¦åŠæ—¶ç»™ä»–åˆ æ‰ï¼Œå› ä¸º selectedKeys é›†åˆä¸­ä¸ä¼šåˆ é™¤å…ƒç´ ï¼Œåªä¼šå°†å¯¹åº” key å‘ç”Ÿçš„äº‹ä»¶åˆ æ‰ï¼Œè€Œä¸ä¼šåˆ æ‰è¿™ä¸ªkeyï¼Œè¿™æ ·ä¸‹æ¬¡å¤„ç†æ—¶æ‹¿åˆ°è¿™ä¸ªkeyå°±ä¼šå¯¹ä¸€ä¸ªç©ºäº‹ä»¶è¿›è¡Œæ“ä½œäº†ï¼Œä¼šå‡ºé—®é¢˜ã€‚
- å®¢æˆ·ç«¯æ–­å¼€è¿æ¥é—®é¢˜ï¼š
  - å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªreadäº‹ä»¶ï¼Œ ä¼šäº§ç”Ÿä¸€ä¸ª Key æ”¾åœ¨ selectedKeys é›†åˆä¸­ï¼Œè‹¥ä¸å¯¹å…¶å¤„ç†ï¼Œä¼šå¯¼è‡´æœåŠ¡ç«¯ä¸€ç›´å¾ªç¯è¯»åˆ°è¯¥keyã€‚
  - ä¸Šè¿°æƒ…å†µå‡ºç°åœ¨å¼ºåˆ¶æ–­å¼€å’Œæ­£å¸¸è°ƒç”¨ `sc.close()` æ–¹æ³•æ—¶éƒ½ä¼šå‡ºç°ã€‚ä½†æ­£å¸¸æ–­å¼€æ—¶ï¼Œä¸èƒ½é€šè¿‡å¼‚å¸¸æ•æ‰åˆ°ï¼Œéœ€é€šè¿‡ read æ—¶çš„è¿”å›ç»“æœä¸º -1 è¿›è¡Œåˆ¤æ–­ã€‚
- æ¶ˆæ¯è¿‡é•¿
  - æ¶ˆæ¯é•¿åº¦è¶…è¿‡channel åˆ†é…çš„ç©ºé—´æ—¶ï¼Œä¸€æ¬¡è¯»ä¸å®Œå°±ä¼šè§¦å‘ç¬¬äºŒæ¬¡è¯»å–ï¼Œä¸ä¼šæŠ¥é”™ï¼Œç›´æ¥æŠŠç¬¬äºŒæ¬¡è¯»å–åˆ°çš„å†…å®¹ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚  =â‡’  ByteBuffer ä¸èƒ½æ˜¯å±€éƒ¨å˜é‡ï¼Œå¿…é¡»åœ¨ä¸¤æ¬¡è¯»å–æ—¶éƒ½è°ƒç”¨åŒä¸€ä¸ªbufferå…±äº«æ•°æ®ã€‚
- å†™å…¥å†…å®¹
  - å†™å…¥å†…å®¹è¿‡å¤šæ—¶ï¼Œä¼šå¯¼è‡´å‘é€æ•°æ®çš„å†™ç¼“å†²åŒºå˜æ»¡ï¼Œæ­¤æ—¶è‹¥çº¿ç¨‹æ— æ³•å¤„ç†å…¶ä»–äº‹ä»¶ï¼Œåˆ™å½±å“æ•ˆç‡ã€‚
  - æ²¡æœ‰æ•°æ®å¯å†™äº†å°±ä¸è¦æŠŠ buffer å…³è”åœ¨ key ä¸Šäº†ï¼Œä¼šå ç”¨å¾ˆå¤§çš„å†…å­˜ã€‚æ‰€ä»¥éœ€è¦æ¸…ç†æ“ä½œ â‡’ å–æ¶ˆå…³è” && å–æ¶ˆå…³æ³¨å¯å†™äº‹ä»¶ã€‚
> å¯å†™äº‹ä»¶ï¼šå†™ç¼“å†²åŒºæœ‰ç©ºä½™äº†ï¼Œå¯ä»¥å†™æ–°å†…å®¹äº†ã€‚

### 4.3 accept äº‹ä»¶å¤„ç†

å®¢æˆ·ç«¯ä»£ç ä¸º

```java
public class Client {
    public static void main(String[] args) {
        try (Socket socket = new Socket("localhost", 8080)) {
            System.out.println(socket);
            socket.getOutputStream().write("world".getBytes());
            System.in.read();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

æœåŠ¡å™¨ç«¯ä»£ç ä¸º

```java
@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        // è·å¾—æœåŠ¡å™¨é€šé“
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
            // åˆ›å»ºé€‰æ‹©å™¨
            Selector selector = Selector.open();
            // é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
            channel.configureBlocking(false);
            // å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                // è‹¥æ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåä¹‹ä¸ä¼šè¢«é˜»å¡ã€‚ä»è€Œé¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå°±ç»ªçš„äº‹ä»¶ä¸ªæ•°
                int count = selector.select();
//                int count = selector.selectNow();
                log.debug("select count: {}", count);

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> keys = selector.selectedKeys();

                // ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
                Iterator<SelectionKey> iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // è·å–è¿æ¥å¹¶å¤„ç†ï¼Œè€Œä¸”æ˜¯å¿…é¡»å¤„ç†ï¼Œå¦åˆ™éœ€è¦å–æ¶ˆ
                        SocketChannel sc = c.accept();
                        log.debug("{}", sc);
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

#### ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†

> äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘
> äº‹ä»¶çš„å¤„ç†ï¼šä¸Šè¿°ä»£ç ä¸­åŒ…å« `SocketChannel sc = c.accept();` çš„ if è¯­å¥å—å°±æ˜¯å¤„ç†ã€‚
> æˆ–è€… `key.cancle()` ä¹Ÿæ˜¯å¤„ç†ã€‚

### 4.4  read äº‹ä»¶å¤„ç†

- åœ¨ Accept äº‹ä»¶ä¸­ï¼Œè‹¥æœ‰å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹äº†è¿æ¥ï¼Œéœ€è¦å°†å…¶å¯¹åº”çš„ SocketChannel è®¾ç½®ä¸ºéé˜»å¡ï¼Œå¹¶æ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­
- æ·»åŠ Readäº‹ä»¶ï¼Œè§¦å‘åè¿›è¡Œè¯»å–æ“ä½œ

```java
@Slf4j
public class ChannelDemo6 {
    public static void main(String[] args) {
        // è·å¾—æœåŠ¡å™¨é€šé“
        try (ServerSocketChannel channel = ServerSocketChannel.open()) {
            channel.bind(new InetSocketAddress(8080));
             // åˆ›å»ºé€‰æ‹©å™¨
            Selector selector = Selector.open();
            // é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
            channel.configureBlocking(false);
            // å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            channel.register(selector, SelectionKey.OP_ACCEPT);

            while (true) {
                // è‹¥æ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåä¹‹ä¸ä¼šè¢«é˜»å¡ã€‚ä»è€Œé¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå°±ç»ªçš„äº‹ä»¶ä¸ªæ•°
                int count = selector.select();
//                int count = selector.selectNow();
                log.debug("select count: {}", count);

                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> keys = selector.selectedKeys();

                // ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
                Iterator<SelectionKey> iter = keys.iterator();
                while (iter.hasNext()) {
                    SelectionKey key = iter.next();
                    // åˆ¤æ–­äº‹ä»¶ç±»å‹
                    if (key.isAcceptable()) {
                        // è·å¾—keyå¯¹åº”çš„channel
                        ServerSocketChannel c = (ServerSocketChannel) key.channel();
                        // è·å–è¿æ¥
                        SocketChannel sc = c.accept();
                        // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
                        sc.configureBlocking(false);
                        // å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­
                        sc.register(selector, SelectionKey.OP_READ);
                        log.debug("è¿æ¥å·²å»ºç«‹: {}", sc);
                    } else if (key.isReadable()) {
                        SocketChannel sc = (SocketChannel) key.channel();
                        ByteBuffer buffer = ByteBuffer.allocate(128); // è¿™é‡Œçš„ buffer ä¸èƒ½å®šä¹‰ä¸ºå…¨å±€çš„ï¼Œå› ä¸ºå¤šä¸ªå®¢æˆ·ç«¯å¯èƒ½ä¼šå…¬ç”¨ä¸€ä¸ªbuffer è€Œå†²çª
                        int read = sc.read(buffer);
                        if(read == -1) {
                            key.cancel();
                            sc.close();
                        } else {
                            buffer.flip();
                            debug(buffer);
                        }
                    }
                    // å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤
                    iter.remove();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º

```
sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 6f 72 6c 64                                  |world           |
+--------+-------------------------------------------------+----------------+
```

#### ğŸ’¡ ä¸ºä½•è¦ iter.remove()

> å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤ã€‚ä¾‹å¦‚
>
> * ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey 
> * ç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨éå†å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸

#### ğŸ’¡ cancel çš„ä½œç”¨

> cancel ä¼šå–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶

#### æ–­å¼€å¤„ç†

å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„**è¿æ¥æ–­å¼€æ—¶ï¼Œä¼šç»™æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ªè¯»äº‹ä»¶**ï¼Œå¯¹å¼‚å¸¸æ–­å¼€å’Œæ­£å¸¸æ–­å¼€éœ€è¦åŠ ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

- æ­£å¸¸æ–­å¼€
  - æ­£å¸¸æ–­å¼€æ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„ `channel.read(buffer)` æ–¹æ³•çš„è¿”å›å€¼ä¸º-1ï¼Œæ‰€ä»¥å½“ç»“æŸåˆ°è¿”å›å€¼ä¸º-1æ—¶ï¼Œéœ€è¦è°ƒç”¨ key çš„ cancel æ–¹æ³•å–æ¶ˆæ­¤äº‹ä»¶ï¼Œå¹¶åœ¨å–æ¶ˆåç§»é™¤è¯¥äº‹ä»¶

```java
int read = channel.read(buffer);
// æ–­å¼€è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªå†™äº‹ä»¶ï¼Œæ­¤æ—¶readçš„è¿”å›å€¼ä¸º-1
if(read == -1) {
    // å–æ¶ˆè¯¥äº‹ä»¶çš„å¤„ç†
	key.cancel();
    channel.close();
} else {
    ...
}
// å–æ¶ˆæˆ–è€…å¤„ç†ï¼Œéƒ½éœ€è¦ç§»é™¤key
iterator.remove();
```

- å¼‚å¸¸æ–­å¼€
  - å¼‚å¸¸æ–­å¼€æ—¶ï¼Œä¼šæŠ›å‡ºIOExceptionå¼‚å¸¸ï¼Œ åœ¨try-catchçš„**catchå—ä¸­æ•è·å¼‚å¸¸å¹¶è°ƒç”¨keyçš„cancelæ–¹æ³•å³å¯**

#### æ¶ˆæ¯è¾¹ç•Œå¤„ç†

**ä¸å¤„ç†æ¶ˆæ¯è¾¹ç•Œå­˜åœ¨çš„é—®é¢˜ï¼š**

å°†ç¼“å†²åŒºçš„å¤§å°è®¾ç½®ä¸º4ä¸ªå­—èŠ‚ï¼Œå‘é€2ä¸ªæ±‰å­—ï¼ˆä½ å¥½ï¼‰ï¼Œé€šè¿‡decodeè§£ç å¹¶æ‰“å°æ—¶ï¼Œä¼šå‡ºç°ä¹±ç 

```java
ByteBuffer buffer = ByteBuffer.allocate(4);
// è§£ç å¹¶æ‰“å°
System.out.println(StandardCharsets.UTF_8.decode(buffer));
```

```text
ä½ ï¿½
ï¿½ï¿½
```

è¿™æ˜¯å› ä¸ºUTF-8å­—ç¬¦é›†ä¸‹ï¼Œ1ä¸ªæ±‰å­—å ç”¨3ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶ç¼“å†²åŒºå¤§å°ä¸º4ä¸ªå­—èŠ‚ï¼Œä¸€æ¬¡è¯»æ—¶é—´æ— æ³•å¤„ç†å®Œé€šé“ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¸€å…±ä¼šè§¦å‘ä¸¤æ¬¡è¯»äº‹ä»¶ã€‚è¿™å°±å¯¼è‡´ ä½ å¥½ çš„ å¥½ å­—è¢«æ‹†åˆ†ä¸ºäº†å‰åŠéƒ¨åˆ†å’ŒååŠéƒ¨åˆ†å‘é€ï¼Œè§£ç æ—¶å°±ä¼šå‡ºç°é—®é¢˜

**å¤„ç†æ¶ˆæ¯è¾¹ç•Œï¼š**

ä¼ è¾“çš„æ–‡æœ¬å¯èƒ½æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

- æ–‡æœ¬å¤§äºç¼“å†²åŒºå¤§å°
  - æ­¤æ—¶éœ€è¦å°†ç¼“å†²åŒºè¿›è¡Œæ‰©å®¹
- å‘ç”ŸåŠåŒ…ç°è±¡
- å‘ç”Ÿç²˜åŒ…ç°è±¡

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231018162100.png" alt="20231018162100" style="zoom:75%;" /></center>

è§£å†³æ€è·¯å¤§è‡´æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š

- å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œå½“å‘é€çš„æ•°æ®è¾ƒå°‘æ—¶ï¼Œéœ€è¦å°†æ•°æ®è¿›è¡Œå¡«å……ï¼Œç›´åˆ°é•¿åº¦ä¸æ¶ˆæ¯è§„å®šé•¿åº¦ä¸€è‡´ã€‚ç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½
- å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦åœ°å»åŒ¹é…åˆ†éš”ç¬¦
- TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯åœ¨æ¶ˆæ¯å¼€å¤´ç”¨ä¸€äº›ç©ºé—´å­˜æ”¾åé¢æ•°æ®çš„é•¿åº¦ï¼‰ï¼Œå¦‚HTTPè¯·æ±‚å¤´ä¸­çš„ Content-Type ä¸ Content-Lengthã€‚ç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡
  - Http 1.1 æ˜¯ TLV æ ¼å¼
  - Http 2.0 æ˜¯ LTV æ ¼å¼
  
<font color='blue'>ä¸‹æ–‡çš„æ¶ˆæ¯è¾¹ç•Œå¤„ç†æ–¹å¼ä¸ºç¬¬äºŒç§ï¼šæŒ‰åˆ†éš”ç¬¦æ‹†åˆ†</font>

**é™„ä»¶ä¸æ‰©å®¹**

Channel çš„ register æ–¹æ³•è¿˜æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š`attachment`ï¼Œå¯ä»¥å‘å…¶ä¸­æ”¾å…¥ä¸€ä¸ª Object ç±»å‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šä¸ç™»è®°çš„ Channel ä»¥åŠå…¶å¯¹åº”çš„ SelectionKey ç»‘å®šï¼Œå¯ä»¥ä» SelectionKey è·å–åˆ°å¯¹åº”é€šé“çš„é™„ä»¶.

```java
public final SelectionKey register(Selector sel, int ops, Object att)
```

å¯é€šè¿‡ SelectionKe çš„ attachment() æ–¹æ³•è·å¾—é™„ä»¶:

```java
ByteBuffer buffer = (ByteBuffer) key.attachment();
```

æˆ‘ä»¬éœ€è¦åœ¨ <font color='red'>Accept äº‹ä»¶å‘ç”Ÿå</font>ï¼Œå°†é€šé“æ³¨å†Œåˆ° Selector ä¸­æ—¶ï¼Œå¯¹æ¯ä¸ªé€šé“æ·»åŠ ä¸€ä¸ª ByteBuffer é™„ä»¶ï¼Œ<font color='red'>è®©æ¯ä¸ªé€šé“å‘ç”Ÿè¯»äº‹ä»¶æ—¶éƒ½ä½¿ç”¨è‡ªå·±çš„é€šé“</font>ï¼Œé¿å…ä¸å…¶ä»–é€šé“å‘ç”Ÿå†²çªè€Œå¯¼è‡´é—®é¢˜.

```java{5}
// è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­ï¼ŒåŒæ—¶è®¾ç½®é™„ä»¶
socketChannel.configureBlocking(false);
ByteBuffer buffer = ByteBuffer.allocate(16);
// æ·»åŠ é€šé“å¯¹åº”çš„Bufferé™„ä»¶
socketChannel.register(selector, SelectionKey.OP_READ, buffer);
```

å½“ Channel ä¸­çš„æ•°æ®å¤§äºç¼“å†²åŒºæ—¶ï¼Œéœ€è¦å¯¹ç¼“å†²åŒºè¿›è¡Œ**æ‰©å®¹**æ“ä½œã€‚

æ­¤ä»£ç ä¸­çš„**æ‰©å®¹çš„åˆ¤å®šæ–¹æ³•ï¼š** Channel è°ƒç”¨ compact æ–¹æ³•åï¼Œposition ä¸ limit ç›¸ç­‰ï¼Œè¯´æ˜ç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶æœªè¢«è¯»å–ï¼ˆå®¹é‡å¤ªå°ï¼‰ï¼Œæ­¤æ—¶åˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼Œå…¶å¤§å°æ‰©å¤§ä¸ºä¸¤å€ã€‚åŒæ—¶è¿˜è¦å°†æ—§ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°çš„ç¼“å†²åŒºä¸­ï¼ŒåŒæ—¶è°ƒç”¨ SelectionKey çš„ attach æ–¹æ³•å°†æ–°çš„ç¼“å†²åŒºä½œä¸ºæ–°çš„é™„ä»¶æ”¾å…¥ SelectionKey ä¸­

```java
// å¦‚æœç¼“å†²åŒºå¤ªå°ï¼Œå°±è¿›è¡Œæ‰©å®¹
if (buffer.position() == buffer.limit()) {
    ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity()*2);
    // å°†æ—§bufferä¸­çš„å†…å®¹æ”¾å…¥æ–°çš„bufferä¸­
    ewBuffer.put(buffer);
    // å°†æ–°bufferä½œä¸ºé™„ä»¶æ”¾åˆ°keyä¸­
    key.attach(newBuffer);
}
```

**æ”¹é€ åçš„æœåŠ¡å™¨ä»£ç å¦‚ä¸‹:**

```java
public class SelectServer {
    public static void main(String[] args) {
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            server.bind(new InetSocketAddress(8080));
            // åˆ›å»ºé€‰æ‹©å™¨
            Selector selector = Selector.open();
            // é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
            server.configureBlocking(false);
            // å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            server.register(selector, SelectionKey.OP_ACCEPT);
            // ä¸ºserverKeyè®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            while (true) {
                // è‹¥æ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåä¹‹ä¸ä¼šè¢«é˜»å¡ã€‚ä»è€Œé¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå°±ç»ªçš„äº‹ä»¶ä¸ªæ•°
                int ready = selector.select();
                System.out.println("selector ready counts : " + ready);
                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> selectionKeys = selector.selectedKeys();
                // ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
                Iterator<SelectionKey> iterator = selectionKeys.iterator();
                while (iterator.hasNext()) {
                    SelectionKey key = iterator.next();
                    // åŠæ—¶ç§»é™¤
                    iterator.remove();
                    // åˆ¤æ–­keyçš„ç±»å‹
                    if(key.isAcceptable()) {
                        // è·å¾—keyå¯¹åº”çš„channel
                        ServerSocketChannel channel = (ServerSocketChannel) key.channe();
                        System.out.println("before accepting...");
                        // è·å–è¿æ¥
                        SocketChannel socketChannel = channel.accept();
                        System.out.println("after accepting...");
                        // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­ï¼ŒåŒæ—¶è®¾ç½®é™„ä»¶
                        socketChannel.configureBlocking(false);
                        ByteBuffer buffer = ByteBuffer.allocate(16);
                        socketChannel.register(selector, SelectionKey.OP_READ, buffer);
                        // // å¤„ç†å®Œæ¯•åç§»é™¤
                        // iterator.remove();
                    } else if (key.isReadable()) {
                        SocketChannel channel = (SocketChannel) key.channel();
                        System.out.println("before reading...");
                        // é€šè¿‡keyè·å¾—é™„ä»¶ï¼ˆbufferï¼‰
                        ByteBuffer buffer = (ByteBuffer) key.attachment();
                        int read = channel.read(buffer);
                        if(read == -1) {
                            key.cancel();
                            channel.close();
                        } else {
                            // é€šè¿‡åˆ†éš”ç¬¦æ¥åˆ†éš”bufferä¸­çš„æ•°æ®
                            split(buffer);
                            // å¦‚æœç¼“å†²åŒºå¤ªå°ï¼Œå°±è¿›è¡Œæ‰©å®¹
                            if (buffer.position() == buffer.limit()) {
                                ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity()*2);
                                // å°†æ—§bufferä¸­çš„å†…å®¹æ”¾å…¥æ–°çš„bufferä¸­
                                buffer.flip();
                                newBuffer.put(buffer);
                                // å°†æ–°bufferæ”¾åˆ°keyä¸­ä½œä¸ºé™„ä»¶
                                key.attach(newBuffer);
                            }
                        }
                        System.out.println("after reading...");
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static void split(ByteBuffer buffer) {
        buffer.flip();
        for(int i = 0; i < buffer.limit(); i++) {
            // éå†å¯»æ‰¾åˆ†éš”ç¬¦
            // get(i)ä¸ä¼šç§»åŠ¨position
            if (buffer.get(i) == '\n') {
                // ç¼“å†²åŒºé•¿åº¦
                int length = i+1-buffer.position();
                ByteBuffer target = ByteBuffer.allocate(length);
                // å°†å‰é¢çš„å†…å®¹å†™å…¥targetç¼“å†²åŒº
                for(int j = 0; j < length; j++) {
                    // å°†bufferä¸­çš„æ•°æ®å†™å…¥targetä¸­
                    target.put(buffer.get());
                }
                // æ‰“å°ç»“æœ
                ByteBufferUtil.debugAll(target);
            }
        }
        // åˆ‡æ¢ä¸ºå†™æ¨¡å¼ï¼Œä½†æ˜¯ç¼“å†²åŒºå¯èƒ½æœªè¯»å®Œï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨compact
        buffer.compact();
    }
}
```

#### ByteBuffer å¤§å°åˆ†é…

- æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º **ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨**ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer
- ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer
  - ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° [http://tutorials.jenkov.com/java-performance/resizable-array.html](http://tutorials.jenkov.com/java-performance/resizable-array.html)
  - å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—

### 4.5 write äº‹ä»¶å¤„ç†

æœåŠ¡å™¨é€šè¿‡Bufferå‘é€šé“ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¯èƒ½å› ä¸ºé€šé“å®¹é‡å°äºBufferä¸­çš„æ•°æ®å¤§å°ï¼Œå¯¼è‡´ `SocketChannel.write(buffer)` æ— æ³•ä¸€æ¬¡æ€§å°†Bufferä¸­çš„æ•°æ®å…¨éƒ¨å†™å…¥åˆ°Channelä¸­ï¼Œè¿™æ—¶ä¾¿éœ€è¦åˆ†å¤šæ¬¡å†™å…¥ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹:

1. æ‰§è¡Œä¸€æ¬¡å†™æ“ä½œï¼Œå‘å°†bufferä¸­çš„å†…å®¹å†™å…¥åˆ°SocketChannelä¸­ï¼Œç„¶ååˆ¤æ–­Bufferä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®
2. è‹¥Bufferä¸­è¿˜æœ‰æ•°æ®ï¼Œåˆ™<font color='blue'>éœ€è¦å°†SockerChannelæ³¨å†Œåˆ°Seletorä¸­ï¼Œå¹¶å…³æ³¨å†™äº‹ä»¶ï¼ŒåŒæ—¶å°†æœªå†™å®Œçš„Bufferä½œä¸ºé™„ä»¶ä¸€èµ·æ”¾å…¥åˆ°SelectionKeyä¸­</font>

```java{6}
int write = socket.write(buffer);
// é€šé“ä¸­å¯èƒ½æ— æ³•æ”¾å…¥ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®
if (buffer.hasRemaining()) {
    // æ³¨å†Œåˆ°Selectorä¸­ï¼Œå…³æ³¨å¯å†™äº‹ä»¶ï¼Œå¹¶å°†bufferæ·»åŠ åˆ°keyçš„é™„ä»¶ä¸­
    socket.configureBlocking(false);
    socket.register(selector, SelectionKey.OP_WRITE, buffer);
}
```

3. æ·»åŠ å†™äº‹ä»¶çš„ç›¸å…³æ“ä½œ `key.isWritable()`ï¼Œå¯¹Bufferå†æ¬¡è¿›è¡Œå†™æ“ä½œ
  - æ¯æ¬¡å†™åéœ€è¦åˆ¤æ–­Bufferä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼ˆæ˜¯å¦å†™å®Œï¼‰ã€‚<font color='blue'>è‹¥å†™å®Œï¼Œéœ€è¦ç§»é™¤SelecionKeyä¸­çš„Bufferé™„ä»¶ï¼Œé¿å…å…¶å ç”¨è¿‡å¤šå†…å­˜ï¼ŒåŒæ—¶è¿˜éœ€ç§»é™¤å¯¹å†™äº‹ä»¶çš„å…³æ³¨</font>

```java{9-10}
SocketChannel socket = (SocketChannel) key.channel();
// è·å¾—buffer
ByteBuffer buffer = (ByteBuffer) key.attachment();
// æ‰§è¡Œå†™æ“ä½œ
int write = socket.write(buffer);
System.out.println(write);
// å¦‚æœå·²ç»å®Œæˆäº†å†™æ“ä½œï¼Œéœ€è¦ç§»é™¤keyä¸­çš„é™„ä»¶ï¼ŒåŒæ—¶ä¸å†å¯¹å†™äº‹ä»¶æ„Ÿå…´è¶£
if (!buffer.hasRemaining()) {
    key.attach(null);
    key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
}
```

**æ•´ä½“ä»£ç å¦‚ä¸‹:**

```java
public class WriteServer {

    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        ssc.bind(new InetSocketAddress(8080));

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        while(true) {
            selector.select();

            Iterator<SelectionKey> iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    SelectionKey sckey = sc.register(selector, SelectionKey.OP_READ);
                    // 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i < 3000000; i++) {
                        sb.append("a");
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());
                    int write = sc.write(buffer);
                    // 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    // 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶
                    if (buffer.hasRemaining()) {
                        // read 1  write 4
                        // åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶
                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);
                        // æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey
                        sckey.attach(buffer);
                    }
                } else if (key.isWritable()) {
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    SocketChannel sc = (SocketChannel) key.channel();
                    int write = sc.write(buffer);
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    if (!buffer.hasRemaining()) { // å†™å®Œäº†
                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
                        key.attach(null);
                    }
                }
            }
        }
    }
}
```

#### ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ

åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨

### 4.6 ä¼˜åŒ–

#### ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–

åˆ†ä¸¤ç»„é€‰æ‹©å™¨

* å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼ˆBossï¼‰ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶
* åˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼ˆWorkerï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶
  * Worker éœ€è¦å®ç° Runnable æ¥å£ â‡’ æ–°åˆ›å»ºçº¿ç¨‹æ—¶æ‰§è¡Œçš„æ–¹æ³•è®©ä»–ç›´æ¥åœ¨Workerä¸­æ‰¾

:::tip ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´ä¼ é€’æ¶ˆæ¯ï¼šç”¨æ¶ˆæ¯é˜Ÿåˆ—. 

```java
private ConcurrentLinkedQueue<Runnable> queue = new ConcurrentLinkedQueue<>();
```

ConcurrentLinkedQueue æ˜¯å¹¶å‘å®‰å…¨çš„

=â‡’ ç”¨é˜Ÿåˆ—æ¥è§£è€¦ï¼Œ<font color='red'>â€œé˜Ÿåˆ—ï¼Œå°±æ˜¯ç”¨æ¥åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’æ¶ˆæ¯çš„â€</font>

:::

```java
public class ChannelDemo7 {
    public static void main(String[] args) throws IOException {
        new BossEventLoop().register();
    }

    @Slf4j
    static class BossEventLoop implements Runnable {
        private Selector boss;
        private WorkerEventLoop[] workers;
        private volatile boolean start = false;
        AtomicInteger index = new AtomicInteger();

        public void register() throws IOException {
            if (!start) {
                ServerSocketChannel ssc = ServerSocketChannel.open();
                ssc.bind(new InetSocketAddress(8080));
                ssc.configureBlocking(false);
                boss = Selector.open();
                SelectionKey ssckey = ssc.register(boss, 0, null);
                ssckey.interestOps(SelectionKey.OP_ACCEPT);
                workers = initEventLoops();
                new Thread(this, "boss").start();
                log.debug("boss start...");
                start = true;
            }
        }

        public WorkerEventLoop[] initEventLoops() {
//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];
            WorkerEventLoop[] workerEventLoops = new WorkerEventLoop[2];
            for (int i = 0; i < workerEventLoops.length; i++) {
                workerEventLoops[i] = new WorkerEventLoop(i);
            }
            return workerEventLoops;
        }

        @Override
        public void run() {
            while (true) {
                try {
                    boss.select();
                    Iterator<SelectionKey> iter = boss.selectedKeys().iterator();
                    while (iter.hasNext()) {
                        SelectionKey key = iter.next();
                        iter.remove();
                        if (key.isAcceptable()) {
                            ServerSocketChannel c = (ServerSocketChannel) key.channel();
                            SocketChannel sc = c.accept();
                            sc.configureBlocking(false);
                            log.debug("{} connected", sc.getRemoteAddress());
                            workers[index.getAndIncrement() % workers.length].register(sc);
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    @Slf4j
    static class WorkerEventLoop implements Runnable {
        private Selector worker;
        private volatile boolean start = false;
        private int index;

        private final ConcurrentLinkedQueue<Runnable> tasks = new ConcurrentLinkedQueue<>();

        public WorkerEventLoop(int index) {
            this.index = index;
        }

        public void register(SocketChannel sc) throws IOException {
            if (!start) {
                worker = Selector.open();
                new Thread(this, "worker-" + index).start();
                start = true;
            }
            tasks.add(() -> {
                try {
                    SelectionKey sckey = sc.register(worker, 0, null);
                    sckey.interestOps(SelectionKey.OP_READ);
                    worker.selectNow();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            });
            worker.wakeup();
        }

        @Override
        public void run() {
            while (true) {
                try {
                    worker.select();
                    Runnable task = tasks.poll();
                    if (task != null) {
                        task.run();
                    }
                    Set<SelectionKey> keys = worker.selectedKeys();
                    Iterator<SelectionKey> iter = keys.iterator();
                    while (iter.hasNext()) {
                        SelectionKey key = iter.next();
                        if (key.isReadable()) {
                            SocketChannel sc = (SocketChannel) key.channel();
                            ByteBuffer buffer = ByteBuffer.allocate(128);
                            try {
                                int read = sc.read(buffer);
                                if (read == -1) {
                                    key.cancel();
                                    sc.close();
                                } else {
                                    buffer.flip();
                                    log.debug("{} message:", sc.getRemoteAddress());
                                    debugAll(buffer);
                                }
                            } catch (IOException e) {
                                e.printStackTrace();
                                key.cancel();
                                sc.close();
                            }
                        }
                        iter.remove();
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```

ğŸ’¡ **å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°**

> * Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°
> * è¿™ä¸ªé—®é¢˜ç›´åˆ° jdk 10 æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯

**æç¤ºï¼š**IO å¯†é›†å‹ç¨‹åºï¼Œç›´æ¥æŠŠçº¿ç¨‹ä¸ªæ•°è®¾ç½®ä¸ºCPUä¸ªæ•°å³å¯ï¼Œä½†è‹¥IOè¾ƒå°‘ï¼Œåˆ™å‚è€ƒé˜¿å§†è¾¾å°”å®šå¾‹è¿›è¡Œè®¾ç½®

### 4.7 UDP

* UDP æ˜¯æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯
* server è¿™è¾¹çš„ receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ

## 5. NIO vs BIO

### 5.1 stream vs channel

streamï¼šæ–‡ä»¶/socketçš„è¾“å…¥è¾“å‡ºæµ

* stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰
* stream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨
* äºŒè€…å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ

### :star: 5.2 IO æ¨¡å‹

åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€<font color='red'>å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰</font>ã€å¼‚æ­¥éé˜»å¡

* åŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰
* å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰
* é˜»å¡ï¼šé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ* 
* éé˜»å¡ï¼šéé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ

å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š

* ç­‰å¾…æ•°æ®é˜¶æ®µ
* å¤åˆ¶æ•°æ®é˜¶æ®µ
  * ä»å†…æ ¸ç¼“å†²åŒºå°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç¼“å†²åŒº
  * éé˜»å¡åªæ˜¯åœ¨æ•°æ®ç­‰å¾…é˜¶æ®µéé˜»å¡äº†ï¼Œæ•°æ®å¤åˆ¶é˜¶æ®µè¿˜æ˜¯é˜»å¡çš„

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019140458.png" alt="20231019140458" style="zoom:75%;" /></center>

æ ¹æ®UNIX ç½‘ç»œç¼–ç¨‹ - å· Iï¼ŒIOæ¨¡å‹ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§:

1. é˜»å¡ IO

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019140629.png" alt="20231019140629" style="zoom:75%;" /></center>

- ç”¨æˆ·çº¿ç¨‹è¿›è¡Œreadæ“ä½œæ—¶ï¼Œéœ€è¦ç­‰å¾…æ“ä½œç³»ç»Ÿæ‰§è¡Œå®é™…çš„readæ“ä½œï¼Œæ­¤æœŸé—´ç”¨æˆ·çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„ï¼Œæ— æ³•æ‰§è¡Œå…¶ä»–æ“ä½œ

2. éé˜»å¡ IO

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019140803.png" alt="20231019140803" style="zoom:75%;" /></center>

- ç”¨æˆ·çº¿ç¨‹åœ¨ä¸€ä¸ªå¾ªç¯ä¸­**ä¸€ç›´è°ƒç”¨readæ–¹æ³•**ï¼Œè‹¥å†…æ ¸ç©ºé—´ä¸­è¿˜æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œç«‹å³è¿”å›
  - åªæ˜¯åœ¨ç­‰å¾…é˜¶æ®µéé˜»å¡
- ç”¨æˆ·çº¿ç¨‹å‘ç°å†…æ ¸ç©ºé—´ä¸­æœ‰æ•°æ®åï¼Œç­‰å¾…å†…æ ¸ç©ºé—´æ‰§è¡Œå¤åˆ¶æ•°æ®ï¼Œå¾…å¤åˆ¶ç»“æŸåè¿”å›ç»“æœã€‚
  - å¤åˆ¶é˜¶æ®µæ˜¯é˜»å¡çš„

3. å¤šè·¯å¤ç”¨

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019142008.png" alt="20231019142008" style="zoom:75%;" /></center>

**Javaä¸­é€šè¿‡Selectorå®ç°å¤šè·¯å¤ç”¨**

- å½“æ²¡æœ‰äº‹ä»¶æ—¶ï¼Œè°ƒç”¨selectæ–¹æ³•ä¼šè¢«é˜»å¡ä½
- ä¸€æ—¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå¤„ç†å¯¹åº”çš„äº‹ä»¶ï¼Œä»è€Œå®ç°å¤šè·¯å¤ç”¨

**å¤šè·¯å¤ç”¨ä¸é˜»å¡IOçš„åŒºåˆ«**

- é˜»å¡IOæ¨¡å¼ä¸‹ï¼Œè‹¥çº¿ç¨‹å› acceptäº‹ä»¶è¢«é˜»å¡ï¼Œå‘ç”Ÿreadäº‹ä»¶åï¼Œä»éœ€ç­‰å¾…acceptäº‹ä»¶æ‰§è¡Œå®Œæˆåï¼Œæ‰èƒ½å»å¤„ç†readäº‹ä»¶
- å¤šè·¯å¤ç”¨æ¨¡å¼ä¸‹ï¼Œ<font color='blue'>ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿåï¼Œè‹¥å¦ä¸€ä¸ªäº‹ä»¶å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸ä¼šå½±å“è¯¥äº‹ä»¶çš„æ‰§è¡Œ</font>

4. ä¿¡å·é©±åŠ¨

5. å¼‚æ­¥ IO

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019143055.png" alt="20231019143055" style="zoom:75%;" /></center>

- çº¿ç¨‹1è°ƒç”¨æ–¹æ³•åç†è§£è¿”å›ï¼Œä¸ä¼šè¢«é˜»å¡ä¹Ÿä¸éœ€è¦ç«‹å³è·å–ç»“æœ
- å½“æ–¹æ³•çš„è¿è¡Œç»“æœå‡ºæ¥ä»¥åï¼Œç”±çº¿ç¨‹2å°†ç»“æœè¿”å›ç»™çº¿ç¨‹1

### 5.3 é›¶æ‹·è´

<mark>é›¶æ‹·è´æŒ‡çš„æ˜¯æ•°æ®æ— éœ€æ‹·è´åˆ° JVM å†…å­˜ä¸­</mark>ï¼ŒåŒæ—¶å…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªä¼˜ç‚¹

- æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢
- ä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«
- é›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“

#### ä¼ ç»Ÿ IO é—®é¢˜

éœ€æ±‚ï¼šä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå°†å…¶é€šè¿‡socketå‘é€ç»™å®¢æˆ·ç«¯ã€‚ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡ºï¼ˆbufå°±æ˜¯ç”¨æˆ·ç¼“å†²åŒºï¼‰

```java
File f = new File("helloword/data.txt");
RandomAccessFile file = new RandomAccessFile(file, "r");

byte[] buf = new byte[(int)f.length()];
file.read(buf);

Socket socket = ...;
socket.getOutputStream().write(buf);
```

å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019143454.png" alt="20231019143454" style="zoom:75%;" /></center>

1. java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu

   > DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO

2. ä»**å†…æ ¸æ€**åˆ‡æ¢å›**ç”¨æˆ·æ€**ï¼Œå°†æ•°æ®ä»**å†…æ ¸ç¼“å†²åŒº**è¯»å…¥**ç”¨æˆ·ç¼“å†²åŒº**ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA

3. è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»**ç”¨æˆ·ç¼“å†²åŒº**ï¼ˆbyte[] bufï¼‰å†™å…¥ **socket ç¼“å†²åŒº**ï¼Œcpu ä¼šå‚ä¸æ‹·è´

4. æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† **socket ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu


å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„

* ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§
* æ•°æ®æ‹·è´äº†å…± 4 æ¬¡

#### NIO ä¼˜åŒ–

é€šè¿‡ DirectByteBuf 

* ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜
* ByteBuffer.allocateDirect(10)  <font color='blue'>DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜ï¼ˆä½†æ˜¯javaå¯ä»¥ç›´æ¥è®¿é—®ï¼‰</font>

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019143850.png" alt="20231019143850" style="zoom:75%;" /></center>

å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨

* è¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™
* java ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥
  * DirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—
  * é€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜
* å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘

#### è¿›ä¸€æ­¥ä¼˜åŒ– 1

**ä»¥ä¸‹ä¸¤ç§æ–¹å¼éƒ½æ˜¯é›¶æ‹·è´**ï¼Œå³æ— éœ€å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºä¸­ï¼ˆJVMå†…å­˜ä¸­ï¼‰

åº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ <mark>transferTo/transferFrom</mark> æ–¹æ³•æ‹·è´æ•°æ®

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019144659.png" alt="20231019144659" style="zoom:75%;" /></center>

1. java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ï¼Œä¸ä¼šä½¿ç”¨ cpu
2. æ•°æ®ä»**å†…æ ¸ç¼“å†²åŒº**ä¼ è¾“åˆ° **socket ç¼“å†²åŒº**ï¼Œcpu ä¼šå‚ä¸æ‹·è´
3. æœ€åä½¿ç”¨ DMA å°† **socket ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu

å¯ä»¥çœ‹åˆ°

* åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢
* æ•°æ®æ‹·è´äº† 3 æ¬¡

#### è¿›ä¸€æ­¥ä¼˜åŒ– 2

linux 2.4 å¯¹ä¸Šè¿°æ–¹æ³•å†æ¬¡è¿›è¡Œäº†ä¼˜åŒ–

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231019144748.png" alt="20231019144748" style="zoom:75%;" /></center>

1. java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„**ç”¨æˆ·æ€**åˆ‡æ¢è‡³**å†…æ ¸æ€**ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥**å†…æ ¸ç¼“å†²åŒº**ï¼Œä¸ä¼šä½¿ç”¨ cpu
2. åªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ **socket ç¼“å†²åŒº**ï¼Œå‡ ä¹æ— æ¶ˆè€—
3. ä½¿ç”¨ DMA å°† **å†…æ ¸ç¼“å†²åŒº**çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu

æ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡.

### 5.4 AIO

AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜

* åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®
* å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ

> å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ
>
> * Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO
> * Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿

## æˆ‘çš„çå†™

å¼‚æ­¥IOåœ¨Linuxä¸­æ˜¯å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿçš„å¼‚æ­¥IOï¼ŒNetty5ä¹Ÿæ˜¯è¿™ä¹ˆå®ç°äº†ä¸€å¥—ï¼Œä½†æ˜¯å‘ç°æ²¡æœ‰ä¼˜åŠ¿ï¼Œäºæ˜¯å¼ƒç”¨äº†ç‰ˆæœ¬5ï¼Œç°åœ¨æœ€é«˜ç‰ˆæœ¬è¿˜æ˜¯4ã€‚

`.twr`ï¼štry... catch...ï¼Œä¿è¯channelèƒ½å¤Ÿæ­£å¸¸å…³é—­

å¼‚æ­¥è°ƒç”¨æ—¶ï¼Œè‹¥ä¸»çº¿ç¨‹ç»“æŸé€€å‡ºï¼Œåˆ™å®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šç»“æŸï¼Œå“ªæ€•ä»–æ´»å„¿æ²¡å¹²å®Œã€‚

