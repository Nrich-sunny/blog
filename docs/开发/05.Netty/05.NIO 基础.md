---
title: NIO åŸºç¡€
date: 2023-10-07 10:04:38
permalink: /pages/8aa77e/
categories:
  - å¼€å‘
  - Netty
tags:
  - 
---


# NIO åŸºç¡€

NIO => non-blocking io => éé˜»å¡ IO

## 1. ä¸‰å¤§ç»„ä»¶

### 1.1 Channel ä¸ Buffer

Java NIOç³»ç»Ÿçš„æ ¸å¿ƒåœ¨äºï¼šé€šé“(Channel)å’Œç¼“å†²åŒº(Buffer)ã€‚**é€šé“**è¡¨ç¤ºæ‰“å¼€åˆ° IO è®¾å¤‡(ä¾‹å¦‚ï¼šæ–‡ä»¶ã€å¥—æ¥å­—)çš„è¿æ¥ã€‚è‹¥éœ€è¦ä½¿ç”¨ NIO ç³»ç»Ÿï¼Œéœ€è¦è·å–ç”¨äºè¿æ¥ IO è®¾å¤‡çš„é€šé“ä»¥åŠç”¨äºå®¹çº³æ•°æ®çš„**ç¼“å†²åŒº**ã€‚ç„¶åæ“ä½œç¼“å†²åŒºï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚

channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„**åŒå‘é€šé“**ï¼Œstream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œé€šé“è´Ÿè´£ä¼ è¾“ï¼Œç¼“å†²åŒºè´Ÿè´£å­˜å‚¨ã€‚

å¸¸è§çš„Channelæœ‰ä»¥ä¸‹å››ç§ï¼Œå…¶ä¸­FileChannelä¸»è¦ç”¨äºæ–‡ä»¶ä¼ è¾“ï¼Œå…¶ä½™ä¸‰ç§ç”¨äºç½‘ç»œé€šä¿¡

+ FileChannel
+ DatagramChannel: UDP ç¼–ç¨‹æ—¶çš„æ•°æ®ä¼ è¾“é€šé“
+ SocketChannel: TCP ç¼–ç¨‹æ—¶çš„æ•°æ®ä¼ è¾“é€šé“
+ ServerSocketChannel: TCP ç¼–ç¨‹æ—¶æœåŠ¡å™¨ç«¯çš„æ•°æ®ä¼ è¾“é€šé“

Bufferæœ‰ä»¥ä¸‹å‡ ç§ï¼Œå…¶ä¸­ä½¿ç”¨è¾ƒå¤šçš„æ˜¯ByteBuffer

+ ByteBuffer
    + MappedByteBuffer
    + DirectByteBuffer
    + HeapByteBuffer
+ ShortBuffer
+ IntBuffer
+ LongBuffer
+ FloatBuffer
+ DoubleBuffer
+ CharBuffer

### 1.2 Selector

åœ¨ä½¿ç”¨ Selector ä¹‹å‰ï¼ŒæœåŠ¡å™¨ä¸Šå¤„ç† socket è¿æ¥è¿˜æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•:

1. å¤šçº¿ç¨‹ç‰ˆè®¾è®¡
2. çº¿ç¨‹æ± ç‰ˆè®¾è®¡

#### (1) å¤šçº¿ç¨‹ç‰ˆè®¾è®¡

ä¸ºæ¯ä¸ªè¿æ¥åˆ†åˆ«å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å»å¤„ç†å¯¹åº”çš„ socket è¿æ¥ã€‚

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231010121038.png" alt="20231010121038" style="zoom:75%;" /></center>

**ç¼ºç‚¹ï¼š**
+ å†…å­˜å ç”¨é«˜
    + æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œå½“è¿æ¥è¾ƒå¤šæ—¶ï¼Œä¼šå¼€è¾Ÿå¤§é‡çº¿ç¨‹ï¼Œå¯¼è‡´å ç”¨å¤§é‡å†…å­˜
+ çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜
+ åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯
    + è¿æ¥æ•°è¿‡å¤šï¼Œä¼šå¯¼è‡´åˆ›å»ºå¾ˆå¤šçº¿ç¨‹ï¼Œä»è€Œå‡ºç°é—®é¢˜

#### (2) çº¿ç¨‹æ± ç‰ˆè®¾è®¡

ä½¿ç”¨çº¿ç¨‹æ± ï¼Œè®©çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å»å¤„ç†è¿æ¥ã€‚

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231010121053.png" alt="20231010121053" style="zoom:75%;" /></center>

**ç¼ºç‚¹ï¼š**
+ é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥
    + çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è·å–ä»»åŠ¡ï¼ˆtaskï¼‰åï¼Œ<font color='red'>åªæœ‰å½“å…¶æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼ˆæ–­å¼€è¿æ¥åï¼‰ï¼Œæ‰ä¼šå»è·å–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</font>
    + è‹¥sockeè¿æ¥ä¸€ç›´æœªæ–­å¼€ï¼Œåˆ™å…¶å¯¹åº”çš„çº¿ç¨‹æ— æ³•å¤„ç†å…¶ä»–sockeè¿æ¥
+ ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯
    + çŸ­è¿æ¥å³å»ºç«‹è¿æ¥å‘é€è¯·æ±‚å¹¶å“åº”åå°±ç«‹å³æ–­å¼€ï¼Œä½¿å¾—çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥å¿«é€Ÿå¤„ç†å…¶ä»–è¿æ¥

#### (3) selector ç‰ˆè®¾è®¡

selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼ˆfileChannelå› ä¸ºæ˜¯é˜»å¡å¼çš„ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨selectorï¼‰ï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œè¿™äº› channel å·¥ä½œåœ¨**éé˜»å¡æ¨¡å¼**ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚å½“ä¸€ä¸ªchannelä¸­æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶ä»–channelä¸­çš„ä»»åŠ¡ã€‚é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰ã€‚

> æµé‡ä½ï¼šæ•°æ®ä¼ è¾“é‡å°‘ã€‚

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231010121108.png" alt="20231010121108" style="zoom:75%;" /></center>

è‹¥äº‹ä»¶æœªå°±ç»ªï¼Œè°ƒç”¨ selector çš„ select() æ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ° channel å‘ç”Ÿäº†å°±ç»ªäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å°±ç»ªåï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†ã€‚

## 2. ByteBuffer

### 2.1 ä½¿ç”¨æ¡ˆä¾‹

**ä½¿ç”¨æ–¹å¼ï¼š**

+ å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)
+ è°ƒç”¨ flip() åˆ‡æ¢è‡³è¯»æ¨¡å¼
    + flip ä¼šä½¿å¾— buffer ä¸­çš„ limit å˜ä¸º positionï¼Œposition å˜ä¸º 0
+ ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()
+ è°ƒç”¨ clear() æˆ–è€… compact() åˆ‡æ¢è‡³å†™æ¨¡å¼
    + è°ƒç”¨ clear() æ–¹æ³•æ—¶ position=0ï¼Œlimit å˜ä¸º capacity
    + è°ƒç”¨ compact() æ–¹æ³•æ—¶ï¼Œä¼šå°†ç¼“å†²åŒºä¸­çš„æœªè¯»æ•°æ®å‹ç¼©åˆ°ç¼“å†²åŒºå‰é¢
+ é‡å¤ä»¥ä¸Šæ­¥éª¤

**ä½¿ç”¨ ByteBuffer è¯»å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š**

```java
@Slf4j
public class TestByteBuffer {
    public static void main(String[] args) {
        // FileChannel
        // æ­¤å¤„ç”¨è¾“å…¥è¾“å‡ºæµçš„æ–¹å¼
        try (FileChannel channel = new FileInputStream("data.txt").getChannel()) { // ç”¨ twr è¿›è¡Œè‡ªåŠ¨å…³é—­ channel
            // å‡†å¤‡ç¼“å†²åŒº
            ByteBuffer buffer = ByteBuffer.allocate(10);
            do {
                // ä» channel è¯»å–æ•°æ®ï¼Œå†™å…¥ buffer
                int len = channel.read(buffer);
                log.debug("è¯»å–åˆ°çš„å­—èŠ‚æ•° {}", len);
                if (len == -1) {  // æ ¹æ®é•¿åº¦åˆ¤æ–­æ˜¯å¦å·²ç»è¯»å–å®Œæˆ
                    break;
                }
                // æ‰“å° buffer å†…å®¹
                buffer.flip();  // åˆ‡æ¢è‡³è¯»æ¨¡å¼
                while (buffer.hasRemaining()) {
                    byte b = buffer.get();
                    log.debug("å®é™…å­—èŠ‚ {}", (char) b);
                }
                // åˆ‡æ¢ buffer å†™æ¨¡å¼
                buffer.clear();
            } while (true);
        } catch (IOException e) {
        }
    }
}
```

### 2.2 ByteBuffer ç»“æ„

ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§

+ capacity
+ position
+ limit

æœ€åˆï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111530.png" alt="20231009111530" style="zoom:75%;" /></center>

å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111609.png" alt="20231009111609" style="zoom:75%;" /></center>

**flip åŠ¨ä½œå‘ç”Ÿå**ï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111649.png" alt="20231009111649" style="zoom:75%;" /></center>

è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111732.png" alt="20231009111732" style="zoom:75%;" /></center>

**clear åŠ¨ä½œå‘ç”Ÿå**ï¼ŒçŠ¶æ€ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111750.png" alt="20231009111750" style="zoom:75%;" /></center>

**compact æ–¹æ³•**ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼ï¼š

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20231009111821.png" alt="20231009111821" style="zoom:75%;" /></center>



#### ğŸ’¡ è°ƒè¯•å·¥å…·ç±»

```java
public class ByteBufferUtil {
    private static final char[] BYTE2CHAR = new char[256];
    private static final char[] HEXDUMP_TABLE = new char[256 * 4];
    private static final String[] HEXPADDING = new String[16];
    private static final String[] HEXDUMP_ROWPREFIXES = new String[65536 >>> 4];
    private static final String[] BYTE2HEX = new String[256];
    private static final String[] BYTEPADDING = new String[16];

    static {
        final char[] DIGITS = "0123456789abcdef".toCharArray();
        for (int i = 0; i < 256; i++) {
            HEXDUMP_TABLE[i << 1] = DIGITS[i >>> 4 & 0x0F];
            HEXDUMP_TABLE[(i << 1) + 1] = DIGITS[i & 0x0F];
        }

        int i;

        // Generate the lookup table for hex dump paddings
        for (i = 0; i < HEXPADDING.length; i++) {
            int padding = HEXPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding * 3);
            for (int j = 0; j < padding; j++) {
                buf.append("   ");
            }
            HEXPADDING[i] = buf.toString();
        }

        // Generate the lookup table for the start-offset header in each row (up to 64KiB).
        for (i = 0; i < HEXDUMP_ROWPREFIXES.length; i++) {
            StringBuilder buf = new StringBuilder(12);
            buf.append(NEWLINE);
            buf.append(Long.toHexString(i << 4 & 0xFFFFFFFFL | 0x100000000L));
            buf.setCharAt(buf.length() - 9, '|');
            buf.append('|');
            HEXDUMP_ROWPREFIXES[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-hex-dump conversion
        for (i = 0; i < BYTE2HEX.length; i++) {
            BYTE2HEX[i] = ' ' + StringUtil.byteToHexStringPadded(i);
        }

        // Generate the lookup table for byte dump paddings
        for (i = 0; i < BYTEPADDING.length; i++) {
            int padding = BYTEPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding);
            for (int j = 0; j < padding; j++) {
                buf.append(' ');
            }
            BYTEPADDING[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-char conversion
        for (i = 0; i < BYTE2CHAR.length; i++) {
            if (i <= 0x1f || i >= 0x7f) {
                BYTE2CHAR[i] = '.';
            } else {
                BYTE2CHAR[i] = (char) i;
            }
        }
    }

    /**
     * æ‰“å°æ‰€æœ‰å†…å®¹
     * @param buffer
     */
    public static void debugAll(ByteBuffer buffer) {
        int oldlimit = buffer.limit();
        buffer.limit(buffer.capacity());
        StringBuilder origin = new StringBuilder(256);
        appendPrettyHexDump(origin, buffer, 0, buffer.capacity());
        System.out.println("+--------+-------------------- all ------------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), oldlimit);
        System.out.println(origin);
        buffer.limit(oldlimit);
    }

    /**
     * æ‰“å°å¯è¯»å–å†…å®¹
     * @param buffer
     */
    public static void debugRead(ByteBuffer buffer) {
        StringBuilder builder = new StringBuilder(256);
        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());
        System.out.println("+--------+-------------------- read -----------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), buffer.limit());
        System.out.println(builder);
    }

    private static void appendPrettyHexDump(StringBuilder dump, ByteBuffer buf, int offset, int length) {
        if (isOutOfBounds(offset, length, buf.capacity())) {
            throw new IndexOutOfBoundsException(
                    "expected: " + "0 <= offset(" + offset + ") <= offset + length(" + length
                            + ") <= " + "buf.capacity(" + buf.capacity() + ')');
        }
        if (length == 0) {
            return;
        }
        dump.append(
                "         +-------------------------------------------------+" +
                        NEWLINE + "         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |" +
                        NEWLINE + "+--------+-------------------------------------------------+----------------+");

        final int startIndex = offset;
        final int fullRows = length >>> 4;
        final int remainder = length & 0xF;

        // Dump the rows which have 16 bytes.
        for (int row = 0; row < fullRows; row++) {
            int rowStartIndex = (row << 4) + startIndex;

            // Per-row prefix.
            appendHexDumpRowPrefix(dump, row, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + 16;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(" |");

            // ASCII dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append('|');
        }

        // Dump the last row which has less than 16 bytes.
        if (remainder != 0) {
            int rowStartIndex = (fullRows << 4) + startIndex;
            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + remainder;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(HEXPADDING[remainder]);
            dump.append(" |");

            // Ascii dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append(BYTEPADDING[remainder]);
            dump.append('|');
        }

        dump.append(NEWLINE +
                "+--------+-------------------------------------------------+----------------+");
    }

    private static void appendHexDumpRowPrefix(StringBuilder dump, int row, int rowStartIndex) {
        if (row < HEXDUMP_ROWPREFIXES.length) {
            dump.append(HEXDUMP_ROWPREFIXES[row]);
        } else {
            dump.append(NEWLINE);
            dump.append(Long.toHexString(rowStartIndex & 0xFFFFFFFFL | 0x100000000L));
            dump.setCharAt(dump.length() - 9, '|');
            dump.append('|');
        }
    }

    public static short getUnsignedByte(ByteBuffer buffer, int index) {
        return (short) (buffer.get(index) & 0xFF);
    }
}
```

è°ƒç”¨ï¼š`ByteBufferUtil.debugAll(buffer);`ã€‚

### 2.3 ByteBuffer å¸¸è§æ–¹æ³•

#### ï¼ˆ1ï¼‰åˆ†é…ç©ºé—´

å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•

```java
Bytebuffer buf = ByteBuffer.allocate(16);
```

è¿™ç§åŠæ³•æ˜¯åˆ†é…åœ¨å †å†…å­˜ä¸Šçš„ï¼Œè¯»å†™æ•ˆç‡è¾ƒä½ï¼Œä¼šå—åˆ° GC çš„å½±å“ã€‚
ä½† `java.nio.DirectByteBuffer` æ˜¯åˆ†é…åœ¨ç›´æ¥å†…å­˜ï¼ˆç³»ç»Ÿå†…å­˜ï¼‰ä¸Šçš„ï¼Œä¸ä¼šå— GC å½±å“ï¼Œè¯»å†™æ•ˆç‡é«˜ï¼ˆå°‘ä¸€æ¬¡æ‹·è´ï¼‰ï¼Œä½†åˆ†é…æ•ˆç‡ä½ï¼Œä¸”å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚

#### ï¼ˆ2ï¼‰å‘ buffer å†™å…¥æ•°æ®

æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ read æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•

```java
int readBytes = channel.read(buf);
```

å’Œ

```java
 buf.put((byte) 0x61); // 'a'
 buffer.put(new byte[]{'a','b','c','d'});
```

#### ï¼ˆ3ï¼‰ä» buffer è¯»å–æ•°æ®

åŒæ ·æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ write æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•

```java
int writeBytes = channel.write(buf);
```

å’Œ

```java
byte b = buf.get();
buf.get(new byte[4]);
```

get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœ**æƒ³é‡å¤è¯»å–æ•°æ®**

* å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0
* æˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ

#### ï¼ˆ4ï¼‰mark å’Œ reset

mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®ã€‚ç›¸å½“äºå¯¹ rewind çš„ä¸€ä¸ªå¢å¼ºï¼Œå¯ä»¥å›åˆ°é 0 ä½ç½®ã€‚

> **æ³¨æ„**
>
> rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®

#### è°ƒç”¨ ByteBuffer çš„æ–¹æ³•

```java
public class TestByteBufferReadWrite {
    public static void main(String[] args) {
        // ä¸º ByteBuffer åˆ†é…ç©ºé—´
        ByteBuffer buffer = ByteBuffer.allocate(10);


        // å‘bufferä¸­å†™å…¥1ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put((byte) 0x61);  // 'a', åè¿›åˆ¶ 97
        // ä½¿ç”¨å·¥å…·ç±»ï¼ŒæŸ¥çœ‹bufferçŠ¶æ€
        debugAll(buffer);

        // å‘bufferä¸­å†™å…¥4ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put(new byte[]{98, 99, 100, 101});
        ByteBufferUtil.debugAll(buffer);

        // è·å–æ•°æ®
        buffer.flip();
        ByteBufferUtil.debugAll(buffer);
        System.out.println(buffer.get());
        System.out.println(buffer.get());
        ByteBufferUtil.debugAll(buffer);

        // ä½¿ç”¨ compact åˆ‡æ¢æ¨¡å¼
        buffer.compact();
        ByteBufferUtil.debugAll(buffer);

        // å†æ¬¡å†™å…¥
        buffer.put((byte)102);  // 'd'
        buffer.put((byte)103);  // 'e'
        ByteBufferUtil.debugAll(buffer);
    }
}
```

è¿è¡Œç»“æœï¼š

```plaintext
+--------+-------------------- all ------------------------+----------------+
position: [1], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 00 00 00 00 00 00 00 00 00                   |a.........      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
97
98
+--------+-------------------- all ------------------------+----------------+
position: [2], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [3], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 64 65 00 00 00 00 00                   |cdede.....      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 66 67 00 00 00 00 00                   |cdefg.....      |
+--------+-------------------------------------------------+----------------+
```

### 2.4 å­—ç¬¦ä¸²ä¸ ByteBuffer çš„ç›¸äº’è½¬æ¢

#### ï¼ˆ1ï¼‰æ–¹æ³•ä¸€: getByte() + StandardCharsets.decode()

ç¼–ç ï¼šå­—ç¬¦ä¸²è°ƒç”¨ getByte() æ–¹æ³•è·å¾— byte æ•°ç»„ï¼Œå°† byte æ•°ç»„æ”¾å…¥ ByteBuffer ä¸­

è§£ç ï¼š**å…ˆè°ƒç”¨ ByteBuffer çš„ flip() æ–¹æ³•**ï¼Œç„¶åé€šè¿‡ StandardCharsets çš„ decoder æ–¹æ³•è§£ç 

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";


        ByteBuffer buffer1 = ByteBuffer.allocate(16);
        // é€šè¿‡å­—ç¬¦ä¸²çš„getByteæ–¹æ³•è·å¾—å­—èŠ‚æ•°ç»„ï¼Œæ”¾å…¥ç¼“å†²åŒºä¸­
        buffer1.put(str1.getBytes());
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // åˆ‡æ¢æ¨¡å¼
        buffer1.flip();
        
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœ:

```plain
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [16]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
```

#### ï¼ˆ2ï¼‰æ–¹æ³•äºŒï¼šStandardCharsets.encode() + StandardCharsets.decode()

ç¼–ç ï¼šé€šè¿‡ StandardCharsets.encode() æ–¹æ³•è·å¾— ByteBufferï¼Œ**æ­¤æ—¶è·å¾—çš„ ByteBuffer ä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡ flip åˆ‡æ¢æ¨¡å¼**

è§£ç ï¼šé€šè¿‡ StandardCharsets.decode() æ–¹æ³•è§£ç 

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";

        // é€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBuffer
        // æ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼
        ByteBuffer buffer1 = StandardCharsets.UTF_8.encode(str1);
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœï¼š

```java
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
```

#### ï¼ˆ3ï¼‰æ–¹æ³•ä¸‰ï¼šStandardCharsets.encode() + StandardCharsets.decode()

ç¼–ç ï¼šå­—ç¬¦ä¸²è°ƒç”¨ getByte() æ–¹æ³•è·å¾—å­—èŠ‚æ•°ç»„ï¼Œå°†å­—èŠ‚æ•°ç»„ä¼ ç»™ ByteBuffer.wrap() æ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•è·å¾— ByteBufferã€‚åŒæ ·**æ— éœ€è°ƒç”¨ flip() æ–¹æ³•åˆ‡æ¢ä¸ºè¯»æ¨¡å¼**

è§£ç ï¼šé€šè¿‡ StandardCharsets.decoder() æ–¹æ³•è§£ç 

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";

        // é€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBuffer
        // æ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼
        ByteBuffer buffer1 = ByteBuffer.wrap(str1.getBytes());
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœï¼š

```java
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
```

#### âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨

> Buffer æ˜¯**éçº¿ç¨‹å®‰å…¨çš„**

### 2.5 åˆ†æ•£è¯»å’Œé›†ä¸­å†™

#### ï¼ˆ1ï¼‰åˆ†æ•£è¯»ï¼ˆScattering Readsï¼‰

åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt

```
onetwothree
```

ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®å¡«å……è‡³å¤šä¸ª buffer

```java{1,6}
try (RandomAccessFile file = new RandomAccessFile("helloword/3parts.txt", "rw")) {
    FileChannel channel = file.getChannel();
    ByteBuffer a = ByteBuffer.allocate(3);
    ByteBuffer b = ByteBuffer.allocate(3);
    ByteBuffer c = ByteBuffer.allocate(5);
    channel.read(new ByteBuffer[]{a, b, c});
    a.flip();
    b.flip();
    c.flip();
    debug(a);
    debug(b);
    debug(c);
} catch (IOException e) { 
    e.printStackTrace();
}
```

ç»“æœ

```
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6f 6e 65                                        |one             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 77 6f                                        |two             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 68 72 65 65                                  |three           |
+--------+-------------------------------------------------+----------------+
```

#### ï¼ˆ2ï¼‰é›†ä¸­å†™(Gathering Writes)

ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel

```java{1,13}
try (RandomAccessFile file = new RandomAccessFile("helloword/3parts.txt", "rw")) {
    FileChannel channel = file.getChannel();
    ByteBuffer d = ByteBuffer.allocate(4);
    ByteBuffer e = ByteBuffer.allocate(4);
    channel.position(11);

    d.put(new byte[]{'f', 'o', 'u', 'r'});
    e.put(new byte[]{'f', 'i', 'v', 'e'});
    d.flip();
    e.flip();
    debug(d);
    debug(e);
    channel.write(new ByteBuffer[]{d, e});
} catch (IOException e) {
    e.printStackTrace();
}
```

è¾“å‡º

```
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 6f 75 72                                     |four            |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 69 76 65                                     |five            |
+--------+-------------------------------------------------+----------------+
```

æ–‡ä»¶å†…å®¹

```
onetwothreefourfive
```

### 2.6 é»åŒ…å’ŒåŠåŒ…

ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \n è¿›è¡Œåˆ†éš”
ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º

* Hello,world\n
* I'm zhangsan\n
* How are you?\n

å¯èƒ½å˜æˆä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (é»åŒ…ï¼ŒåŠåŒ…)

* Hello,world\nI'm zhangsan\nHo
* w are you?\n

